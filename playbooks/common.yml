# INFO: Runtime grouping fallback â€” classifies host by inventory_hostname patterns
- name: Runtime classify host into groups
  hosts: all
  gather_facts: true
  tasks:
    - name: Group by server vs desktop
      group_by:
        key: "{{ 'servers' if inventory_hostname.startswith('srv-') else 'desktops' if inventory_hostname.startswith('ws-') else 'ungrouped' }}"

    - name: Group by server categories
      when: inventory_hostname.startswith('srv-')
      block:
        - group_by:
            key: "server_iac"
          when: "'srv-iac' in inventory_hostname"
        - group_by:
            key: "server_swarm_manager"
          when: "'srv-docker-mgr' in inventory_hostname"
        - group_by:
            key: "server_swarm_host"
          when: "'srv-docker-host' in inventory_hostname"
        - group_by:
            key: "server_utility"
          when: "'srv-utl' in inventory_hostname"

    - name: Group by desktop categories
      when: inventory_hostname.startswith('ws-')
      block:
        - group_by:
            key: "desktop_general"
          when: "'ws-gen' in inventory_hostname"
        - group_by:
            key: "desktop_development"
          when: "'ws-dev' in inventory_hostname"

    - name: Group by region (p=prod, s=stg)
      group_by:
        key: "{{ 'prod' if inventory_hostname[-2] == 'p' else 'stg' if inventory_hostname[-2] == 's' else 'unknown_region' }}"


- hosts: all
  gather_facts: true
  become: true
  become_user: root

  tasks:
    - name: Route to server tasks
      ansible.builtin.include_tasks: ../tasks/servers.yml
      when: "'servers' in group_names"

    - name: Route to desktop tasks
      ansible.builtin.include_tasks: ../tasks/desktops.yml
      when: "'desktops' in group_names"