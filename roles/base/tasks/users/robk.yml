#- name: users | robk | create group
#  tags: users
#  group:
#    name: robk
#    state: present

- name: Check if user exists
  getent:
    database: passwd
    key: robk
  register: user_check
  ignore_errors: yes

- name: users | robk | create user
  tags: users
  user:
    name: robk
#    group: robk
    groups: adm,ansible,sudo
    state: present
    comment: "Rob"
    password: "{{ robk_passwd }}"
    shell: /bin/bash
  when: user_check is failed    

- name: users | robk | robk | add sudoers file
  tags: users
  copy:
    src: users/sudoers_robk
    dest: /etc/sudoers.d/robk
    owner: root
    group: root
    mode: 0440

- name: users | robk | create .ssh directory
  tags: dotfiles,users
  file:
    path: "{{ item.dir }}"
    state: directory
    owner: robk
    group: robk
    mode: 0700
  with_items:
    - { dir: '/home/robk/.ssh' }

- name: users | robk | add public key
  tags: dotfiles,users
  authorized_key:
    user: robk
    key: "{{ item }}"
  with_file:
    - users/robk/ssh/robk_id_ed25519.pub

- name: users | robk | create config directories
  tags: dotfiles,users
  file:
    path: /home/robk/{{ item.dir }}
    state: directory
    owner: robk
    group: robk
    mode: 0700
  with_items:
    - { dir: '.bash' }
    - { dir: '.config' }
    - { dir: '.config/htop' }
    - { dir: '.config/mc' }
    - { dir: '.tmux' }
    - { dir: '.tmux/config' }
    - { dir: '.tmux/plugins' }
    - { dir: '.vim' }
    - { dir: '.vim/autoload' }
    - { dir: '.vim/bundle' }
    - { dir: '.vim/colors' }
    - { dir: '.vim/ftplugin' }
    - { dir: '.zsh' }

- name: users | robk | copy tmux config (server version)
  tags: dotfiles,users
  copy:
    src: users/robk/tmux/tmux.conf.server
    dest: /home/robk/.tmux.conf
    owner: robk
    group: robk
    mode: 0600
  when: "'server' not in group_names"

- name: users | robk | copy tmux config (workstation version)
  tags: dotfiles,users
  copy:
    src: users/robk/tmux/tmux.conf.workstation
    dest: /home/robk/.tmux.conf
    owner: robk
    group: robk
    mode: 0600
  when: "'server' in group_names"